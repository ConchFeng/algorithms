# This is a basic workflow to help you get started with Actions

name: CI

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the "dev" branch
  push:
    branches: [ "dev" ]
  pull_request:
    branches: [ "dev" ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  install-cuda:
    runs-on: windows-2019
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install CUDA 11.1.1
        run: |
          $ErrorActionPreference = "Stop" # Stop on any errors
          # CUDA 11.1 Update 1 network installer URL
          $installerUrl = "https://developer.download.nvidia.com/compute/cuda/11.1.1/local_installers/cuda_11.1.1_456.81_win10.exe"
          $installerPath = "cuda_installer.exe"
          # Download the CUDA installer
          Invoke-WebRequest -Uri $installerUrl -OutFile $installerPath
          # Install CUDA (adjust the components as necessary, silent install, no restart)
          Start-Process -FilePath $installerPath -ArgumentList " -s nvcc_11.1 cuobjdump_11.1 nvprune_11.1 cupti_11.1 cublas_11.1 cublas_dev_11.1 cudart_11.1 cufft_11.1 cufft_dev_11.1 curand_11.1 curand_dev_11.1 cusolver_11.1 cusolver_dev_11.1 cusparse_11.1 cusparse_dev_11.1 nvrtc_11.1 nvrtc_dev_11.1 cuda_samples_11.1 Display.Driver" -Wait -NoNewWindow
          # Verify CUDA installation
        shell: powershell
      
      - name: Print tree structure of BuildCustomizations directory
        run: tree "C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\MSBuild\Microsoft\VC\v160\BuildCustomizations" /f
        shell: cmd

      - name: Print tree structure of NV directory
        run: tree "C:\Program Files\NVIDIA GPU Computing Toolkit" /f
        shell: cmd
        
      - name: ENVVV2
        run: |
          set
          set CUDA_PATH=C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v11.1
          set CUDA_PATH_V11_1=C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v11.1
          set PATH=%CUDA_PATH%\bin;%CUDA_PATH%\libnvvp;%PATH%
          set
        shell: cmd
